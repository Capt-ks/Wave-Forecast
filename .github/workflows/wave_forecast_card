name: Wave Forecast Card Generator

on:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours
  workflow_dispatch:

jobs:
  generate-wave-card:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests pillow numpy matplotlib

      - name: Fetch 7‑Day Wave Forecast (PR + USVI)
        run: |
          python3 << 'EOF'
          import requests, json, os

          # NOAA/NWS Marine Forecast API (Caribbean Waters)
          url = "https://api.weather.gov/gridpoints/SJU/103,45/forecast"
          data = requests.get(url, headers={"User-Agent": "RabirubiaWeather"}).json()

          with open("wave_data.json", "w") as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Generate Wave Forecast Image Card
        run: |
          python3 << 'EOF'
          import json, random
          from datetime import datetime
          from PIL import Image, ImageDraw, ImageFont, ImageFilter

          # Load forecast
          with open("wave_data.json") as f:
              data = json.load(f)

          periods = data["properties"]["periods"][:14]  # 7 days (AM/PM)
          days = {}

          for p in periods:
              day = p["name"].split()[0]
              if day not in days:
                  days[day] = p["detailedForecast"]

          # Marine backgrounds (rotate randomly)
          marine_backgrounds = [
              "assets/marine_bg1.jpg",
              "assets/marine_bg2.jpg",
              "assets/marine_bg3.jpg",
              "assets/marine_bg4.jpg",
              "assets/marine_bg5.jpg"
          ]

          bg_path = random.choice(marine_backgrounds)
          bg = Image.open(bg_path).convert("RGBA")
          bg = bg.resize((1200, 1600))  # Responsive base

          draw = ImageDraw.Draw(bg)

          # RabirubiaWeather brand colors
          brand_blue = (0, 102, 204)
          brand_gold = (255, 204, 0)
          white = (255, 255, 255)

          # Header
          draw.rectangle([(0,0),(1200,180)], fill=brand_blue)
          draw.text((40, 50), "RabirubiaWeather", fill=white, size=72)
          draw.text((40, 120), "7‑Day Wave Forecast • PR & USVI", fill=brand_gold, size=42)

          # Forecast text
          y = 250
          for day, forecast in days.items():
              draw.text((60, y), f"{day}: {forecast}", fill=white, size=36)
              y += 140

          # Disclaimer
          draw.text(
              (40, 1500),
              "Maps and information intended for informational purposes only! "
              "For Emergency situations and/or decisions, please refer to your "
              "local Emergency Management Office and/or the National Weather Service.",
              fill=white,
              size=28
          )

          bg.save("wave_forecast_card.png", optimize=True)
          EOF

      - name: Commit updated card
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add wave_forecast_card.png
          git commit -m "Auto-update wave forecast card"
          git push
