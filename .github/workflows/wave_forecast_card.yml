name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'   # Every 6 hours
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ImageMagick and jq
        run: sudo apt-get update && sudo apt-get install -y imagemagick jq

      - name: Download logo
        run: |
          curl -o logo.png "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png"

      - name: Download random marine background
        run: |
          BG_LIST=(
            "https://images.unsplash.com/photo-1507525428034-b723cf961d3e"
            "https://images.unsplash.com/photo-1500375592092-40eb2168fd21"
            "https://images.unsplash.com/photo-1501959915551-4e8a04a3f9a6"
            "https://images.unsplash.com/photo-1507525428034-b723cf961d3e"
            "https://images.unsplash.com/photo-1493558103817-58b2924bce98"
          )
          URL=${BG_LIST[$RANDOM % ${#BG_LIST[@]}]}
          curl -L "$URL" -o background.jpg

      - name: Fetch NOAA Marine Forecast and generate card
        run: |
          # Fetch 7-day marine forecast (PR & USVI)
          DATA=$(curl -s "https://api.weather.gov/gridpoints/SJU/103,45/forecast")
          PERIODS=$(echo "$DATA" | jq -r '.properties.periods[0:7][] | "\(.name): \(.detailedForecast)"')

          # Format forecast into multiline text
          FORECAST=$(echo "$PERIODS" | sed ':a;N;$!ba;s/\n/\\n/g')

          # Generate card
          convert background.jpg -resize 800x800^ -gravity center -crop 800x800+0+0 +repage \
            -fill 'rgba(0,0,0,0.35)' -draw "rectangle 0,0 800,800" \
            \( logo.png -resize 120x120 \) -gravity NorthWest -geometry +40+40 -composite \
            -fill white -font DejaVu-Sans-Bold -pointsize 48 -gravity NorthWest -annotate +170+70 "RabirubiaWeather" \
            -fill white -pointsize 60 -gravity center -annotate +0-200 "Wave Forecast" \
            -fill white -pointsize 40 -gravity center -annotate +0-120 "Puerto Rico & USVI" \
            -fill white -font DejaVu-Sans -pointsize 28 -gravity center -annotate +0+40 "$FORECAST" \
            -fill '#a0e4ff' -pointsize 22 -gravity South -annotate +0+20 "NOAA Marine Forecast | RabirubiaWeather" \
            wave_card.png

      - name: Commit and push updated image
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
