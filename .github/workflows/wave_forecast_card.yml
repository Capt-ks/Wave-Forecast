name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests

      - name: Generate Wave Forecast Card
        run: |
          python3 << 'EOF'
          import requests, textwrap
          from PIL import Image, ImageDraw, ImageFont
          import io, os

          # Fetch NOAA forecast
          url = "https://api.weather.gov/gridpoints/SJU/103,45/forecast"
          try:
              data = requests.get(url, timeout=20).json()
              periods = data["properties"]["periods"][:7]
          except:
              periods = []

          # Build forecast text
          if not periods:
              forecast_text = "Forecast unavailable at this time."
          else:
              lines = []
              for p in periods:
                  name = p.get("name", "Day")
                  desc = p.get("detailedForecast", "")
                  wrapped = textwrap.fill(f"{name}: {desc}", width=40)
                  lines.append(wrapped)
              forecast_text = "\n\n".join(lines)

          # Download background
          bg_urls = [
              "https://images.unsplash.com/photo-1507525428034-b723cf961d3e",
              "https://images.unsplash.com/photo-1500375592092-40eb2168fd21",
              "https://images.unsplash.com/photo-1501959915551-4e8a04a3f9a6",
              "https://images.unsplash.com/photo-1493558103817-58b2924bce98"
          ]
          try:
              bg_data = requests.get(bg_urls[0], timeout=20).content
              bg = Image.open(io.BytesIO(bg_data)).convert("RGB")
          except:
              bg = Image.new("RGB", (800, 800), "#004488")

          bg = bg.resize((800, 800))

          # Download logo
          try:
              logo_data = requests.get(
                  "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png",
                  timeout=20
              ).content
              logo = Image.open(io.BytesIO(logo_data)).convert("RGBA")
          except:
              logo = Image.new("RGBA", (120, 120), "white")

          logo = logo.resize((120, 120))

          # Draw card
          draw = ImageDraw.Draw(bg)
          overlay = Image.new("RGBA", bg.size, (0, 0, 0, 120))
          bg = Image.alpha_composite(bg.convert("RGBA"), overlay)

          # Fonts
          try:
              font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 48)
              font_sub = ImageFont.truetype("DejaVuSans.ttf", 40)
              font_body = ImageFont.truetype("DejaVuSans.ttf", 26)
              font_footer = ImageFont.truetype("DejaVuSans.ttf", 22)
          except:
              font_title = font_sub = font_body = font_footer = ImageFont.load_default()

          # Place logo
          bg.paste(logo, (40, 40), logo)

          # Text
          draw.text((170, 60), "RabirubiaWeather", fill="white", font=font_title)
          draw.text((400, 200), "Wave Forecast", fill="white", font=font_sub, anchor="mm")
          draw.text((400, 260), "Puerto Rico & USVI", fill="white", font=font_sub, anchor="mm")

          draw.multiline_text((400, 420), forecast_text, fill="white", font=font_body, anchor="mm", align="center")

          draw.text((400, 760), "NOAA Marine Forecast | RabirubiaWeather", fill="#a0e4ff", font=font_footer, anchor="mm")

          # Save
          bg.convert("RGB").save("wave_card.png", optimize=True)
          EOF

      - name: Commit and push updated image
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
