name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests beautifulsoup4

      - name: Generate Wave Forecast Card (HTML-aware)
        run: |
          python3 << 'EOF'
          import requests, re
          from bs4 import BeautifulSoup
          from PIL import Image, ImageDraw, ImageFont
          import io, traceback

          URL = "https://www.ndbc.noaa.gov/data/Forecasts/FZCA52.TJSJ.html"
          ZONE = "AMZ712"
          FALLBACK = "Wave forecast temporarily unavailable."

          print("\n===== FETCHING NDBC =====")
          try:
              r = requests.get(URL, timeout=20)
              r.raise_for_status()
              html = r.text
              print("Fetch OK\n")
          except Exception as e:
              print("Fetch error:", e)
              html = None

          if not html:
              forecast_text = FALLBACK
          else:
              print("===== PARSING HTML =====")
              soup = BeautifulSoup(html, "html.parser")

              # Extract all text
              text = soup.get_text("\n")
              print("HTML stripped\n")

              # Extract AMZ712 block
              print("===== EXTRACTING AMZ712 BLOCK =====")
              pattern = rf"({ZONE}.*?)(AMZ\\d{{3}}|$)"
              m = re.search(pattern, text, re.DOTALL)
              if not m:
                  print("ZONE NOT FOUND")
                  block = None
              else:
                  block = m.group(1)
                  print(block)
              print("===== END BLOCK =====\n")

              if not block:
                  forecast_text = FALLBACK
              else:
                  # Normalize
                  block = block.replace("feet", "ft")

                  # Extract periods using fcst-day labels
                  print("===== EXTRACTING PERIODS =====")
                  lines = block.splitlines()
                  periods = []
                  current_label = None
                  current_text = []

                  for line in lines:
                      line = line.strip()
                      # Detect day labels
                      if re.match(r"^(REST OF TONIGHT|TODAY|MON|TUE|WED|THU|FRI|SAT|SUN)", line):
                          if current_label and current_text:
                              periods.append((current_label, " ".join(current_text)))
                          current_label = line
                          current_text = []
                      else:
                          if current_label:
                              current_text.append(line)

                  if current_label and current_text:
                      periods.append((current_label, " ".join(current_text)))

                  for p in periods:
                      print(p[0], "=>", p[1])
                  print("===== END PERIODS =====\n")

                  # Convert REST OF TONIGHT → TODAY
                  cleaned = []
                  for label, txt in periods:
                      if label == "REST OF TONIGHT":
                          label = "TODAY"
                      cleaned.append((label, txt))

                  # Keep first 6 daytime-style periods
                  cleaned = cleaned[:6]

                  # Parse Wave Detail only
                  print("===== PARSING WAVE DETAIL =====")
                  final_lines = []
                  for label, txt in cleaned:
                      print("Parsing:", label, txt)

                      # Extract first Wave Detail component
                      m = re.search(r"Wave Detail:\s*([A-Za-z]+)\s*(\d+)\s*ft\s*at\s*(\d+)\s*seconds?", txt, re.I)
                      if not m:
                          print("NO WAVE DETAIL FOUND\n")
                          continue

                      direction = m.group(1).upper()
                      height = int(m.group(2))
                      period = m.group(3)

                      # Convert single height → ±1 ft
                      low = height - 1
                      high = height + 1
                      height_str = f"{low}–{high} ft"

                      line = f"{label}: {height_str} @ {period}s {direction}"
                      print("Parsed:", line, "\n")
                      final_lines.append(line)

                  if not final_lines:
                      forecast_text = FALLBACK
                  else:
                      forecast_text = "\n".join(final_lines)

          print("===== FINAL FORECAST =====")
          print(forecast_text)
          print("===== END FORECAST =====\n")

          # ---------------------------------------------------------
          # BACKGROUND IMAGE
          # ---------------------------------------------------------
          try:
              bg_data = requests.get(
                  "https://images.unsplash.com/photo-1507525428034-b723cf961d3e",
                  timeout=20
              ).content
              bg = Image.open(io.BytesIO(bg_data)).convert("RGB")
          except:
              bg = Image.new("RGB", (800, 800), "#004488")

          bg = bg.resize((800, 800))

          # ---------------------------------------------------------
          # LOGO
          # ---------------------------------------------------------
          try:
              logo_data = requests.get(
                  "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png",
                  timeout=20
              ).content
              logo = Image.open(io.BytesIO(logo_data)).convert("RGBA")
          except:
              logo = Image.new("RGBA", (120, 120), "white")

          logo = logo.resize((120, 120))

          # ---------------------------------------------------------
          # DRAW CARD
          # ---------------------------------------------------------
          overlay = Image.new("RGBA", bg.size, (0, 0, 0, 120))
          card = Image.alpha_composite(bg.convert("RGBA"), overlay)
          draw = ImageDraw.Draw(card)

          try:
              font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 48)
              font_sub = ImageFont.truetype("DejaVuSans.ttf", 40)
              font_body = ImageFont.truetype("DejaVuSans.ttf", 28)
              font_footer = ImageFont.truetype("DejaVuSans.ttf", 22)
          except:
              font_title = font_sub = font_body = font_footer = ImageFont.load_default()

          card.paste(logo, (40, 40), logo)
          draw.text((170, 60), "RabirubiaWeather", fill="white", font=font_title)
          draw.text((400, 180), "Wave Forecast", fill="white", font=font_sub, anchor="mm")
          draw.text((400, 240), "North Puerto Rico (AMZ712)", fill="white", font=font_sub, anchor="mm")

          draw.multiline_text(
              (80, 300),
              forecast_text,
              fill="white",
              font=font_body,
              align="left",
              spacing=10
          )

          draw.text(
              (400, 760),
              "NDBC Marine Forecast | RabirubiaWeather.com",
              fill="#a0e4ff",
              font=font_footer,
              anchor="mm"
          )

          card.convert("RGB").save("wave_card.png", optimize=True)
          print("Saved wave_card.png")
          EOF

      - name: Commit and push updated image
        run: |
          if [ ! -f wave_card.png ]; then
            echo "ERROR: wave_card.png not found — aborting commit"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
